<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Slap Game</title>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      overflow:hidden;
      font-family:system-ui,Segoe UI,sans-serif;
      -webkit-user-select:none; user-select:none;
      -webkit-tap-highlight-color:transparent;
      background:#000;
    }

    /* background audio only */
    video#bgAudio{position:fixed;width:1px;height:1px;opacity:0;pointer-events:none}

    .poster{position:fixed;inset:0;background:#000}
    .poster img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover; object-position:center;
    }
    .tint{
      position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.05) 35%, rgba(0,0,0,.55));
      pointer-events:none;
    }
    .flash{
      position:absolute; inset:0;
      background:rgba(255,0,0,.18);
      opacity:0; pointer-events:none;
      transition:opacity .06s linear;
    }

    .hudTop{
      position:absolute;
      top:calc(10px + env(safe-area-inset-top));
      left:12px; right:12px;
      display:flex; gap:10px;
      justify-content:space-between; align-items:center;
      pointer-events:none;
    }
    .hudBox{
      flex:1;
      background:rgba(255,255,255,.92);
      border-radius:14px;
      padding:10px;
      text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      color:#111;
    }
    .hudBox .k{font-size:12px;font-weight:900;opacity:.75}
    .hudBox .v{font-size:22px;font-weight:1000;margin-top:2px}
    .hudBox.time .v{color:#ff5f6d}
    .hudBox.score .v{color:#e0a100}
    .hudBox.best .v{color:#23b26b}

    .playerTag{
      position:absolute;
      top:calc(86px + env(safe-area-inset-top));
      left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,.92);
      color:#111;
      padding:10px 14px;
      border-radius:14px;
      font-weight:1000;
      box-shadow:0 10px 30px rgba(0,0,0,.22);
      pointer-events:none;
      white-space:nowrap;
      max-width:92vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .playerTag span{color:#ff2f8d}

    .titlePop{
      position:absolute;
      left:50%;
      top:calc(140px + env(safe-area-inset-top));
      transform:translate(-50%, 0);
      background:rgba(0,0,0,.62);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:1000;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 14px 40px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition:opacity .12s ease, transform .12s ease;
      text-align:center;
      max-width:92vw;
    }
    .titlePop.show{opacity:1; transform:translate(-50%,-6px)}

    .hint{
      position:absolute;
      left:50%;
      bottom:calc(72px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      background:rgba(0,0,0,.45);
      color:rgba(255,255,255,.9);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      pointer-events:none;
      white-space:nowrap;
    }

    .bottomBar{
      position:absolute;
      left:12px; right:12px;
      bottom:calc(12px + env(safe-area-inset-bottom));
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
    }
    .btn{
      flex:1;
      padding:12px 12px;
      border:none;
      border-radius:14px;
      font-weight:1000;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      cursor:pointer;
    }
    .btn.start{background:rgba(255,255,255,.92); color:#111}
    .btn.restart{background:#ff2f8d; color:#fff}
    .btn.leader{background:rgba(255,255,255,.92); color:#111}
    .btn:active{transform:translateY(1px)}

    .shake{animation:shake .16s linear 1}
    @keyframes shake{
      0%{transform:translate(0)}
      25%{transform:translate(4px,-3px)}
      50%{transform:translate(-4px,3px)}
      75%{transform:translate(3px,3px)}
      100%{transform:translate(0)}
    }

    /* overlays */
    .overlay{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
      padding:14px;
    }
    .overlay.show{display:flex}

    .modal{
      width:min(420px, 94vw);
      background:rgba(255,255,255,.95);
      color:#111;
      border-radius:18px;
      padding:18px;
      box-shadow:0 26px 80px rgba(0,0,0,.45);
    }
    .modal h2{margin:0 0 8px}
    .modal .big{font-size:34px;font-weight:1000;color:#ff2f8d;text-align:center}
    .modal .row{display:flex; gap:10px; margin-top:12px}
    .modal .row button{flex:1}

    /* Name modal */
    .field{margin-top:10px}
    .field label{font-size:12px;font-weight:900;opacity:.8}
    .field input{
      width:100%;
      margin-top:6px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      outline:none;
      font-size:16px;
    }
    .field input:focus{border-color:#ff2f8d; box-shadow:0 0 0 3px rgba(255,47,141,.15)}

    /* Leaderboard table */
    .tabs{display:flex; gap:8px; margin-top:10px}
    .tab{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(0,0,0,.04);
      font-weight:1000;
      cursor:pointer;
      text-align:center;
    }
    .tab.active{
      border-color:#ff2f8d;
      box-shadow:0 0 0 3px rgba(255,47,141,.12);
      background:#fff;
    }
    .tableWrap{
      margin-top:10px;
      max-height:52vh;
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
    }
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 8px; border-bottom:1px solid rgba(0,0,0,.08); font-size:13px}
    th{opacity:.7; text-align:left}
    .right{text-align:right}
  </style>
</head>

<body>
  <video id="bgAudio" src="https://files.catbox.moe/r77wx8.mp4" loop playsinline preload="auto"></video>

  <div class="poster" id="poster">
    <img id="charImg" alt="character" />
    <div class="tint"></div>
    <div class="flash" id="flash"></div>

    <div class="hudTop">
      <div class="hudBox time"><div class="k">‡¶∏‡¶Æ‡ßü</div><div class="v" id="time">01:00</div></div>
      <div class="hudBox score"><div class="k">‡¶•‡¶æ‡¶™‡ßç‡¶™‡ßú</div><div class="v" id="score">0</div></div>
      <div class="hudBox best"><div class="k">‡¶∏‡ßá‡¶∞‡¶æ</div><div class="v" id="best">0</div></div>
    </div>

    <div class="playerTag">‡¶ñ‡ßá‡¶≤‡ßã‡ßü‡¶æ‡ßú: <span id="playerName">Player</span></div>
    <div class="titlePop" id="titlePop">‡¶Æ‡¶æ‡¶¶‡¶ï ‡¶∏‡¶Æ‡ßç‡¶∞‡¶æ‡¶ü ‡¶Ü‡¶¨‡ßç‡¶¨‡¶æ‡¶∏</div>
    <div class="hint">‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßá ‡¶•‡¶æ‡¶™‡ßç‡¶™‡ßú ‡¶¶‡¶ø‡¶® üëÜ</div>

    <div class="bottomBar">
      <button class="btn start" id="btnStart">‚ñ∂ ‡¶∂‡ßÅ‡¶∞‡ßÅ</button>
      <button class="btn restart" id="btnRestart">‚Ü∫ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü</button>
      <button class="btn leader" id="btnLeader">üèÜ ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
    </div>
  </div>

  <!-- Name Overlay -->
  <div class="overlay show" id="nameOverlay">
    <div class="modal">
      <h2 style="text-align:center">‡¶ñ‡ßá‡¶≤‡ßã‡ßü‡¶æ‡ßú‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®</h2>
      <div class="field">
        <label>‡¶®‡¶æ‡¶Æ *</label>
        <input id="nameInput" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" maxlength="24" />
      </div>
      <div class="row">
        <button class="btn restart" id="saveNameBtn">‡¶∏‡ßá‡¶≠</button>
        <button class="btn start" id="skipNameBtn">Skip</button>
      </div>
      <div style="margin-top:10px;opacity:.75;font-weight:800;font-size:12px;text-align:center">
        Start ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá (‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡¶≤‡¶ø‡¶∏‡¶ø)
      </div>
    </div>
  </div>

  <!-- Result Overlay -->
  <div class="overlay" id="resultOverlay">
    <div class="modal">
      <h2 style="text-align:center">‚è∞ ‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑!</h2>
      <div class="big" id="finalScore">0</div>
      <div style="text-align:center;font-weight:1000">Best: <span id="finalBest">0</span></div>
      <div class="row">
        <button class="btn restart" id="btnPlayAgain">‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ñ‡ßá‡¶≤‡ßÅ‡¶®</button>
        <button class="btn start" id="btnCloseResult">‡¶¨‡¶®‡ßç‡¶ß</button>
      </div>
    </div>
  </div>

  <!-- Leaderboard Overlay -->
  <div class="overlay" id="lbOverlay">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2 style="margin:0">üèÜ ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2>
        <button class="btn start" id="btnCloseLB" style="flex:0 0 auto">‡¶¨‡¶®‡ßç‡¶ß</button>
      </div>

      <div class="tabs">
        <div class="tab active" id="tabToday">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞</div>
        <div class="tab" id="tabAll">‡¶∏‡¶∞‡ßç‡¶¨‡¶ï‡¶æ‡¶≤‡ßá‡¶∞</div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>‡¶®‡¶æ‡¶Æ</th>
              <th class="right">‡¶∏‡ßç‡¶ï‡ßã‡¶∞</th>
              <th class="right">‡¶∏‡¶Æ‡ßü</th>
            </tr>
          </thead>
          <tbody id="lbBody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;font-size:12px;opacity:.75;font-weight:800">
        ‡¶è‡¶ñ‡¶® ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá (localStorage)‡•§ ‡¶ö‡¶æ‡¶á‡¶≤‡ßá Firebase ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® leaderboard ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§
      </div>
    </div>
  </div>

<script>
  // Images
  const IDLE_IMG = "https://files.catbox.moe/n5tdgb.jpg";
  const SLAP_IMG = "https://files.catbox.moe/jdabf7.jpg";
  const imgIdle = new Image(); imgIdle.src = IDLE_IMG;
  const imgSlap = new Image(); imgSlap.src = SLAP_IMG;

  // Audio
  const bgAudio = document.getElementById("bgAudio");

  // UI elements
  const poster = document.getElementById("poster");
  const charImg = document.getElementById("charImg");
  const flash = document.getElementById("flash");
  const timeEl = document.getElementById("time");
  const scoreEl = document.getElementById("score");
  const bestEl = document.getElementById("best");
  const playerNameEl = document.getElementById("playerName");
  const titlePop = document.getElementById("titlePop");

  const btnStart = document.getElementById("btnStart");
  const btnRestart = document.getElementById("btnRestart");
  const btnLeader = document.getElementById("btnLeader");

  // overlays
  const nameOverlay = document.getElementById("nameOverlay");
  const nameInput = document.getElementById("nameInput");
  const saveNameBtn = document.getElementById("saveNameBtn");
  const skipNameBtn = document.getElementById("skipNameBtn");

  const resultOverlay = document.getElementById("resultOverlay");
  const finalScoreEl = document.getElementById("finalScore");
  const finalBestEl = document.getElementById("finalBest");
  const btnPlayAgain = document.getElementById("btnPlayAgain");
  const btnCloseResult = document.getElementById("btnCloseResult");

  const lbOverlay = document.getElementById("lbOverlay");
  const btnCloseLB = document.getElementById("btnCloseLB");
  const tabToday = document.getElementById("tabToday");
  const tabAll = document.getElementById("tabAll");
  const lbBody = document.getElementById("lbBody");

  // State
  let running = false;
  let timerId = null;
  let timeLeft = 60;
  let score = 0;
  let slapTimeout = null;
  let titleTimeout = null;

  // Titles
  const titles = [
    "‡¶¨‡ßã‡¶∞‡¶ï‡¶æ ‡¶Ü‡¶¨‡ßç‡¶¨‡¶æ‡¶∏",
    "‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶Æ‡¶æ ‡¶Æ‡¶ø‡¶∞‡ßç‡¶ú‡¶æ ‡¶Ü‡¶¨‡ßç‡¶¨‡¶æ‡¶∏",
    "‡¶Æ‡¶æ‡¶¶‡¶ï ‡¶∏‡¶Æ‡ßç‡¶∞‡¶æ‡¶ü ‡¶Ü‡¶¨‡ßç‡¶¨‡¶æ‡¶∏",
    "‡¶ó‡ßç‡¶Ø‡¶æ‡¶Ç‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßç‡¶¨‡¶æ‡¶∏‡¶â‡¶¶‡ßç‡¶¶‡ßÄ‡¶®",
    "‡¶ö‡¶æ‡¶Å‡¶¶‡¶æ‡¶¨‡¶æ‡¶ú ‡¶Ü‡¶¨‡ßç‡¶¨‡¶æ‡¶∏"
  ];

  // Leaderboard keys
  const KEY_ALL = "slap_lb_all";
  const KEY_TODAY_PREFIX = "slap_lb_today_";

  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function formatTime(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  function safeName(raw){
    const n = String(raw || "").trim();
    if (!n) return "Player";
    // limit length and strip weird control chars
    return n.replace(/[\u0000-\u001F\u007F]/g,"").slice(0,24);
  }

  function loadArr(key){
    try{ return JSON.parse(localStorage.getItem(key) || "[]"); }
    catch{ return []; }
  }
  function saveArr(key, arr){
    localStorage.setItem(key, JSON.stringify(arr));
  }

  function setPlayerNameUI(){
    const saved = safeName(localStorage.getItem("playerName"));
    playerNameEl.textContent = saved;
  }

  function bestAllTime(){
    return Number(localStorage.getItem("bestSlap") || "0");
  }

  function updateBestUI(){
    bestEl.textContent = String(bestAllTime());
  }

  async function goFullscreen(){
    try{
      const el = document.documentElement;
      if (!document.fullscreenElement && el.requestFullscreen) await el.requestFullscreen();
    }catch(e){}
  }

  async function playAudio(){
    try{
      bgAudio.muted = false;
      bgAudio.volume = 1;
      await bgAudio.play();
    }catch(e){
      console.log("audio blocked:", e);
    }
  }

  function startGame(){
    running = true;
    score = 0;
    timeLeft = 60;

    scoreEl.textContent = "0";
    timeEl.textContent = formatTime(timeLeft);
    charImg.src = imgIdle.src;

    resultOverlay.classList.remove("show");

    clearInterval(timerId);
    timerId = setInterval(()=>{
      timeLeft--;
      timeEl.textContent = formatTime(Math.max(0, timeLeft));
      if (timeLeft <= 0) endGame();
    }, 1000);
  }

  function endGame(){
    running = false;
    clearInterval(timerId);

    // Save best
    const prevBest = bestAllTime();
    const newBest = Math.max(score, prevBest);
    localStorage.setItem("bestSlap", String(newBest));
    updateBestUI();

    // Save leaderboard entries
    const name = safeName(localStorage.getItem("playerName"));
    const entry = { name, score, time: new Date().toISOString() };

    // All-time leaderboard
    const all = loadArr(KEY_ALL);
    all.push(entry);
    all.sort((a,b) => b.score - a.score);
    saveArr(KEY_ALL, all.slice(0, 50));

    // Today leaderboard
    const tk = KEY_TODAY_PREFIX + todayKey();
    const td = loadArr(tk);
    td.push(entry);
    td.sort((a,b) => b.score - a.score);
    saveArr(tk, td.slice(0, 50));

    // Show result
    finalScoreEl.textContent = String(score);
    finalBestEl.textContent = String(newBest);
    resultOverlay.classList.add("show");
  }

  function showRandomTitle(){
    // time-based flavour: last 15 sec more ‚Äúaggressive‚Äù
    const pick = titles[Math.floor(Math.random() * titles.length)];
    titlePop.textContent = pick;

    titlePop.classList.add("show");
    clearTimeout(titleTimeout);
    titleTimeout = setTimeout(()=> titlePop.classList.remove("show"), 650);
  }

  function feedback(){
    flash.style.opacity = "1";
    setTimeout(()=> flash.style.opacity = "0", 60);

    poster.classList.remove("shake");
    void poster.offsetWidth;
    poster.classList.add("shake");
  }

  function slap(){
    if (!running) return;

    score++;
    scoreEl.textContent = String(score);

    feedback();
    showRandomTitle();

    charImg.src = imgSlap.src;
    clearTimeout(slapTimeout);
    slapTimeout = setTimeout(()=>{ charImg.src = imgIdle.src; }, 130);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function renderLeaderboard(mode){
    lbBody.innerHTML = "";
    const list = (mode === "all")
      ? loadArr(KEY_ALL)
      : loadArr(KEY_TODAY_PREFIX + todayKey());

    if (!list.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" style="padding:14px;opacity:.7">‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶®‡ßá‡¶á</td>`;
      lbBody.appendChild(tr);
      return;
    }

    list.slice(0, 30).forEach((e, i) => {
      const t = new Date(e.time);
      const hh = String(t.getHours()).padStart(2,"0");
      const mm = String(t.getMinutes()).padStart(2,"0");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(e.name)}</td>
        <td class="right"><b>${e.score}</b></td>
        <td class="right" style="opacity:.75">${hh}:${mm}</td>
      `;
      lbBody.appendChild(tr);
    });
  }

  function openLB(mode){
    lbOverlay.classList.add("show");
    if (mode === "all"){
      tabAll.classList.add("active");
      tabToday.classList.remove("active");
      renderLeaderboard("all");
    } else {
      tabToday.classList.add("active");
      tabAll.classList.remove("active");
      renderLeaderboard("today");
    }
  }

  // Init UI
  charImg.src = imgIdle.src;
  timeEl.textContent = formatTime(60);
  updateBestUI();
  setPlayerNameUI();

  // Name overlay behavior
  const existingName = safeName(localStorage.getItem("playerName"));
  if (existingName && existingName !== "Player") {
    // hide name overlay if already saved
    nameOverlay.classList.remove("show");
  } else {
    nameOverlay.classList.add("show");
  }

  saveNameBtn.addEventListener("click", ()=>{
    const v = safeName(nameInput.value);
    localStorage.setItem("playerName", v);
    setPlayerNameUI();
    nameOverlay.classList.remove("show");
  });

  skipNameBtn.addEventListener("click", ()=>{
    localStorage.setItem("playerName", "Player");
    setPlayerNameUI();
    nameOverlay.classList.remove("show");
  });

  // Tap anywhere (except buttons)
  poster.addEventListener("pointerdown", (e)=>{
    if (e.target && e.target.tagName === "BUTTON") return;
    e.preventDefault();
    slap();
  }, {passive:false});

  // Buttons
  btnStart.addEventListener("click", async ()=>{
    await goFullscreen();
    await playAudio();
    startGame();
  });

  btnRestart.addEventListener("click", async ()=>{
    await goFullscreen();
    await playAudio();
    startGame();
  });

  btnPlayAgain.addEventListener("click", async ()=>{
    resultOverlay.classList.remove("show");
    await goFullscreen();
    await playAudio();
    startGame();
  });

  btnCloseResult.addEventListener("click", ()=> resultOverlay.classList.remove("show"));

  btnLeader.addEventListener("click", ()=> openLB("today"));

  btnCloseLB.addEventListener("click", ()=> lbOverlay.classList.remove("show"));
  lbOverlay.addEventListener("click", (e)=>{ if (e.target === lbOverlay) lbOverlay.classList.remove("show"); });

  tabToday.addEventListener("click", ()=>{
    tabToday.classList.add("active"); tabAll.classList.remove("active");
    renderLeaderboard("today");
  });

  tabAll.addEventListener("click", ()=>{
    tabAll.classList.add("active"); tabToday.classList.remove("active");
    renderLeaderboard("all");
  });

  // keep audio when back
  document.addEventListener("visibilitychange", async ()=>{
    if (!document.hidden && running){
      try{ await bgAudio.play(); }catch(e){}
    }
  });
</script>
</body>
  </html>
